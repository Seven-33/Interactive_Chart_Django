{% extends "admin/index.html" %}
{% load i18n %}

{% block bodyclass %}{{ block.super }} app-{{ app_label }}{% endblock %}

{% if not is_popup %}
{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
&rsaquo;
{% for app in app_list %}
{{ app.name }}
{% endfor %}
</div>
{% endblock %}
{% endif %}

{% block content %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
    <form id="filterForm">
        <label for="year">Choose a year:</label>
        <select name="year" id="year">
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
            <option value="2018">2018</option>
            <option value="2017">2017</option>
            <option value="2016">2016</option>
        </select>
        <input type="submit" value="Load" name="_load">
    </form>
    <script>
        function fetchAndUpdate(chart, endpoint) {
            $.ajax({
                url: endpoint,
                type: "GET",
                dataType: "json",
                success: (jsonResponse) => {
                    // Extract data from the response
                    const title = jsonResponse.title;
                    const labels = jsonResponse.data.labels;
                    const datasets = jsonResponse.data.datasets;

                    // Reset the current chart
                    chart.data.datasets = [];
                    chart.data.labels = [];

                    // Load new data into the chart
                    chart.options.title.text = title;
                    chart.data.labels = labels;
                    datasets.forEach(dataset => {
                        chart.data.datasets.push(dataset);
                    });
                    chart.update();
                },
                error: () => console.log("Failed to fetch chart data from " + endpoint + "!")
            });
        }

        function fetchAndUpdateAll(year) {
            fetchAndUpdate(salesChart, `/shop/chart/sales/${year}/`);
            fetchAndUpdate(spendPerCustomerChart, `/shop/chart/spend-per-customer/${year}/`);
            fetchAndUpdate(paymentSuccessChart, `/shop/chart/payment-success/${year}/`);
            fetchAndUpdate(paymentMethodChart, `/shop/chart/payment-method/${year}/`);
        }

        $(document).ready(function() {
            fetchAndUpdateAll($("#year").children().first().val());
        });

        $("#filterForm").on('submit', (event) => {
            event.preventDefault();

            const year = $("#year").val();
            fetchAndUpdateAll(year)
        });
    </script>
    <canvas id="salesChart"></canvas>
    <canvas id="spendPerCustomerChart"></canvas>
    <canvas id="paymentSuccessChart"></canvas>
    <canvas id="paymentMethodChart"></canvas>
    <script>
        let salesCtx = document.getElementById('salesChart').getContext('2d');
        let salesChart = new Chart(salesCtx, {
            type: 'bar',
            options: {
                responsive: true,
                title: {
                    text: "",
                    display: true
                }
            }
        });
        let spendPerCustomerCtx = document.getElementById('spendPerCustomerChart').getContext('2d');
        let spendPerCustomerChart = new Chart(spendPerCustomerCtx, {
            type: 'line',
            options: {
                responsive: true,
                title: {
                    text: 'Spend per customer',
                    display: true
                }
            }
        });
        let paymentSuccessCtx = document.getElementById('paymentSuccessChart').getContext('2d');
        let paymentSuccessChart = new Chart(paymentSuccessCtx, {
            type: 'pie',
            options: {
                responsive: true,
                title: {
                    text: 'Spend per customer',
                    display: true
                }
            }
        });
        let paymentMethodCtx = document.getElementById('paymentMethodChart').getContext('2d');
        let paymentMethodChart = new Chart(paymentMethodCtx, {
            type: 'pie',
            options: {
                responsive: true,
                title: {
                    text: 'Payment method',
                    display: true
                }
            }
        });
    </script>
    <div id="content-main">
      {% include "admin/app_list.html" with app_list=app_list show_changelinks=True %}
    </div>
{% endblock %}